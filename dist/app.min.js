"use strict";var skunq=angular.module("Skunq",["ui.router"]);skunq.config(["$stateProvider","$qProvider",function(e,t){var s={main:{url:"/"},chat:{url:"/chat",template:"<ui-view></ui-view>"},"chat.show":{url:"/:id",templateUrl:"./assets/templates/chat-window.html"},profile:{url:"/profile",template:"<ui-view></ui-view>"},"profile.show":{url:"/:id",templateUrl:"./assets/templates/profile.html"}};_.each(s,function(t,s){e.state(s,t)})}]),skunq.factory("LocalService",function(){return{saveLocal:function(e){e&&localStorage.setItem("skunq_user",JSON.stringify(e))},deleteLocal:function(){localStorage.removeItem("skunq_user")}}}),skunq.controller("MainController",["$scope","$rootScope","$state","$stateParams","$timeout","LocalService",function(e,t,s,a,n,i){var r=this;r._tmp={},r.errors={},r.baseUrl="http://assignment.bunq.com",r.status={loading:!0,loading_window:!0},r.current_user={name:"",avatar:"",editable:!0},r.friends=[],r.active_chats=[],r.init=function(){r.status.loading=!0;var t=localStorage.getItem("skunq_user");t?(t=JSON.parse(t),_.extend(r.current_user,t),r.loadUserData()):(s.go("main"),setTimeout(function(){r.status.loading=!1,e.$apply(),$("#login-screen").removeClass("loading")},2e3)),$("#create-chat-modal").on("hidden.bs.modal",function(){r.cancelChat()}),e.$on("create-chat",function(){r.saveChat(a.id)}),e.$on("logout",function(){r.resetLoginShade(function(){r.current_user={name:"",avatar:"",editable:!0},i.deleteLocal()})})},r.loadUserData=function(){async.parallel([function(e){r.loadFriends(function(){e()})},function(e){r.loadChatData(function(){e()})}],function(){r.active_chats.length&&_.each(r.active_chats,function(e){if(e.id=e.conversation.id,2==e.users.length){var t=_.find(e.users,function(e){return e.userid!=r.current_user.id}),s=_.find(r.friends,{id:t.userid});_.extend(e,{name:e.conversation.name||s.name,avatar:s.avatar}),s.personal_chat_id=e.conversation.id}else r.friends.length>2&&_.extend(e,{avatar:"../../assets/images/group_avatar.png",name:e.conversation.name})}),s.is("main")?r.active_chats.length?r.showChat(r.active_chats[0].id):r.showProfile(r.current_user.id):s.is("chat.show")?r.active_chats.length?r.showChat(a.id||r.active_chats[0].id):r.showProfile(r.current_user.id):s.is("profile.show")?r.showProfile(a.id||r.current_user.id):r.showProfile(r.current_user.id),r.status.loading=!1,r.removeLoginShade(),n(function(){r.pollMessages()},5e3)})},r.loadFriends=function(e){var t=r.baseUrl+"/users";$.get(t).then(function(t){r.friends=_.map(t,function(e){return _.extend({name:"",avatar:"../../assets/images/avatars/"+e.id+".jpg",new_message:"",editable:!1,active:!1,selected:!1},e)}),_.isFunction(e)&&e()},function(e){console.log("%cErrors","background:red;",e)})},r.loadChatData=function(e){var t=r.baseUrl+"/conversation/user/"+r.current_user.id;$.get(t).then(function(t){r.active_chats=t,_.isFunction(e)&&e()},function(e){console.log("%cErrors","background:red;",e)})},r.getMessages=function(e,t){$.get(r.baseUrl+"/conversation/"+e.id+"/message/limited?limit=50&offset=0").then(function(s){s.length&&(e.last_message=_.last(s.reverse()).id),_.isFunction(t)&&t()},function(e){console.log("%cErrors","background:red;",e)})},r.checkNewMessages=function(e,t){$.get(r.baseUrl+"/conversation/"+e.id+"/new/"+e.last_message).then(function(s){s.length&&(e.last_message=_.last(s).id,e.new_message=!0),_.isFunction(t)&&t()},function(s){e.last_message?_.isFunction(t)&&t():console.log("%cErrors","background:red;",s)})},r.pollMessages=function(e,t){if(r.active_chats.length){var s=_.map(r.active_chats,function(e){return function(t){e.last_message?r.checkNewMessages(e,function(){t()}):r.getMessages(e,function(){t()})}});async.parallel(s,function(){n(function(){r.pollMessages()},5e3)})}else n(function(){r.pollMessages()},5e3)},r.login=function(){r._tmp.username?($("#login-screen .loader").removeClass("white"),r.status.loading=!0,_.extend(r.current_user,{name:_.clone(r._tmp.username),id:Date.now()}),i.saveLocal(r.current_user),$("#login-screen").addClass("loading"),r._tmp={},r.loadUserData()):(r.errors.login=!0,console.log("no display name given"))},r.createTempChat=function(){r._tmp.chat={friends:_.map(r.friends,function(e){return e.selected=!1,e}),users:[],name:""},$("#create-chat-modal").modal("show")},r.saveChat=function(e){if(r.errors.chat={},r.status.saving=!0,e)t={users:[e]};else var t={users:_.map(_.filter(r._tmp.chat.friends,function(e){return e.selected}),"id"),name:_.clone(r._tmp.chat.name)};if(!t.users.length||t.users.length>1&&!t.name)return console.log("Errors"),t.name||(r.errors.chat.name=!0),t.users.length||(r.errors.chat.users=!0),void(r.status.saving=!1);var s,a=!1;if(1==t.users.length&&!t.name&&(a=!0,(s=_.find(r.friends,{id:t.users[0]})).personal_chat_id))return r.status.saving=!1,$("#create-chat-modal").modal("hide"),r.showChat(s.personal_chat_id),void(r.shifted=!1);t.users.push(r.current_user.id),t.users=t.users.join(",");var n=a?"/conversation/personal":"/conversation/group";$.post(r.baseUrl+n,t).then(function(e){$("#create-chat-modal").modal("hide"),r.active_chats.splice(0,0,{id:e.id,name:t.name||s.name,avatar:a?s.avatar:"../../assets/images/group_avatar.png"}),a&&(s.personal_chat_id=e.id),r.status.saving=!1,r.showChat(e.id)},function(e){console.log("%cErrors","background:red;",e)})},r.cancelChat=function(){r._tmp={},r.errors={}},r.showProfile=function(e){if(e){_.each(r.active_chats,function(e){e.active=!1}),_.each(r.friends,function(e){e.active=!1});var t=_.find(r.friends,{id:e});t&&(t.active=!0),s.go("profile.show",{id:e}),r.switchTab("friends")}},r.showChat=function(e){if(e){_.each(r.friends,function(e){e.active=!1}),_.each(r.active_chats,function(e){e.active=!1});var t=_.find(r.active_chats,{id:e});if(t){t.active=!0,t.new_message=!1;var a=_.indexOf(r.active_chats,t);a>0&&(r.active_chats.splice(a,1),r.active_chats.splice(0,0,t))}s.go("chat.show",{id:e}),r.switchTab("chats")}},r.buildLoginShade=function(){$("#login-screen").show();var e=document.getElementById("login-bars").getContext("2d");e.canvas.height=window.innerHeight,e.canvas.width=window.innerWidth;for(var t=0;t<12;t++){var s=e.canvas.width/12,a=e.canvas.height,n=s*t;r.bars.push({w:s,h:a,x:n,color:r.colors[t]})}r.drawBars(e),$("#login-bars").css({opacity:1}),r.init()},r.bars=[],r.drawBars=function(e){var t=e.canvas;e.clearRect(0,0,t.width,t.height);for(var s=0;s<r.bars.length;s++){var a=r.bars[s];e.fillStyle=a.color,e.fillRect(a.x,0,a.w,a.h)}},r.removeLoginShade=function(){function e(){for(var n=0;n<r.bars.length;n++)if(n<=a){var i=r.bars[n];if(i.h<=0){r.bars.splice(n,1);continue}r.bars[n].h=i.h-.1*i.h-1,r.bars[n].h<.8*t.height&&(a=n+1)}r.drawBars(s),r.bars.length?setTimeout(e,10):$("#login-screen").hide()}$("#chat-platform").removeClass("hide");var t=document.getElementById("login-bars"),s=t.getContext("2d"),a=0;r.status.loading_window=!1,e()},r.resetLoginShade=function(e){function t(){for(var a=0;a<r.bars.length;a++){var n=r.bars[a];n.h>=n.max?o=!0:r.bars[a].h=n.h+(.1*(n.max-n.h)+1)}r.drawBars(s),o?($("#login-screen").removeClass("loading"),e()):setTimeout(t,10)}$("#chat-platform").addClass("hide"),$("#login-screen").show().addClass("loading");var s=document.getElementById("login-bars").getContext("2d");r.bars=[];for(var a=0;a<12;a++){var n=s.canvas.width/12,i=n*a;r.bars.push({w:n,h:0,x:i,max:s.canvas.height,color:r.colors[a]})}var o=!1;r.drawBars(s),t(),e()},r.shiftView=function(){$("#chat-platform").toggleClass("shifted"),$("#mobile-menu-btn").toggleClass("fa-rotate-180")},r.switchTab=function(e){$("#"+e+"-tab").tab("show")},r.colors=["#288542","#329a43","#5eb24c","#7fc450","#41b19d","#388abf","#2c68a6","#205576","#822330","#be1a2e","#d37527","#d9b837"]}]),skunq.controller("ChatController",["$scope","$state","$stateParams","$timeout",function(e,t,s,a){var n=this,i=e.main;n.status={loading:!0},n.baseUrl="http://assignment.bunq.com",n._tmp={},n.init=function(){_.extend(n,{current_user:i.current_user,friends:i.friends,active_chats:i.active_chats}),n.current_user&&n.current_user.id||n.logout(),n.loadChat()},n.loadChat=function(){n.status.loading=!0,$.get(n.baseUrl+"/conversation/"+s.id).then(function(e){n.chat=_.extend({id:s.id,messages:[]},e),n.chat.conversation&&n.chat.conversation.name&&(n.chat.name=n.chat.conversation.name),n.friends&&n.friends.length?(n.setUsersInfo(),n.getMessages(function(){n.status.loading=!1})):n.loadFriends(function(){n.setUsersInfo(),n.getMessages(function(){n.status.loading=!1})})},function(e){console.log("%cErrors","background:red;",e)})},n.loadFriends=function(e){var t=n.baseUrl+"/users";$.get(t).then(function(t){n.friends=_.map(t,function(e){return _.extend({name:"",avatar:"../../assets/images/avatars/"+e.id+".jpg",new_message:"",editable:!1,active:!1,selected:!1},e)}),_.isFunction(e)&&e()},function(e){console.log("%cErrors","background:red;",e)})},n.setUsersInfo=function(){n.users_info={},_.each(n.chat.users,function(e){e.userid==n.current_user.id?n.users_info[e.userid]=n.current_user:n.users_info[e.userid]=_.find(n.friends,{id:e.userid})})},n.getMessages=function(e){$.get(n.baseUrl+"/conversation/"+n.chat.id+"/message/limited?limit=50&offset=0").then(function(t){n.chat.messages=_.concat(n.chat.messages,t.reverse()),n.chat.messages.length&&(n.chat.last_message=_.last(n.chat.messages).id),n.pollMessages(),_.isFunction(e)&&e()},function(e){console.log("%cErrors","background:red;",e)})},n.checkNewMessages=function(e){$.get(n.baseUrl+"/conversation/"+n.chat.id+"/new/"+n.chat.last_message).then(function(t){t&&t.length&&(n.chat.messages=_.concat(n.chat.messages,t),n.chat.last_message=_.last(n.chat.messages).id),n.pollMessages(),_.isFunction(e)&&e()},function(t){n.chat.last_message?(n.pollMessages(),_.isFunction(e)&&e()):console.log("%cErrors","background:red;",t)})},n.pollMessages=function(){n.pollTimeout=a(function(){n.chat.last_message?n.checkNewMessages():n.getMessages()},3e3)},n.sendMessage=function(e){if(n._tmp.message||e){var t={tempId:Date.now(),message:_.clone(n._tmp.message),senderId:n.current_user.id,conversationId:n.chat.id,status:"sending"};n.chat.messages.push(t),n._tmp.message="",a.cancel(n.pollTimeout),$.post(n.baseUrl+"/conversation/"+n.chat.id+"/message/send",t).then(function(e){var s=_.indexOf(n.chat.messages,t);_.extend(n.chat.messages[s],{id:e.id,status:"sent",timestamp:r()}),n.chat.last_message=e.id,_.find(i.active_chats,{id:n.chat.id}).last_message=e.id,n.pollMessages(),a(function(){o()},5e3)},function(e){console.log("%cErrors","background:red;",e)})}};var r=function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},o=function(){var e=_.find(n.chat.users,function(e){return e.userid!=n.current_user.id}).userid,t={message:"Sorry about this."+Date.now(),senderId:e,conversationId:n.chat.id};$.post(n.baseUrl+"/conversation/"+n.chat.id+"/message/send",t)};n.init()}]),skunq.controller("ProfileController",["$scope","$state","$stateParams","$timeout",function(e,t,s,a){var n=this,i=e.main;n.status={loading:!0},n.baseUrl="http://assignment.bunq.com",n.init=function(){n.status.loading=!0,_.extend(n,{current_user:i.current_user,friends:i.friends}),n.current_user&&n.current_user.id||n.logout(),s.id==n.current_user.id?(n.profile=n.current_user,n.status.loading=!1):n.friends&&n.friends.length?(n.profile=_.find(n.friends,{id:s.id}),n.status.loading=!1):n.loadFriends(function(){n.profile=_.find(n.friends,{id:s.id}),a(function(){e.$apply(),n.status.loading=!1})})},n.createChat=function(){n.status.loading=!0,e.$emit("create-chat")},n.logout=function(){e.$emit("logout")},n.loadFriends=function(e){var t=n.baseUrl+"/users";$.get(t).then(function(t){n.friends=_.map(t,function(e){return _.extend({name:"",avatar:"../../assets/images/avatars/"+e.id+".jpg",new_message:"",editable:!1,active:!1,selected:!1},e)}),_.isFunction(e)&&e()},function(e){console.log("%cErrors","background:red;",e)})},e.$on("destroy",function(){n.status.loading=!1}),n.init()}]),skunq.directive("skLoader",function(){return{restrict:"E",replace:!1,template:'<div id="sk_loader" class="shade"><div class="loader"></div></div>',link:function(e,t,s){}}});